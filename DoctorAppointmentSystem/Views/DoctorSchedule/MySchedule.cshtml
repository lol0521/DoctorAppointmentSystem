@model DoctorAppointmentSystem.ViewModels.ScheduleViewModel

@{
    ViewData["Title"] = "My Schedule";
    Layout = "~/Views/Shared/_DoctorSidebar.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="~/css/myschedule.css" asp-append-version="true" />
}

<div class="schedule-container mt-4">
    <h2 class="mb-3 text-center">Set Your Available Slots</h2>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }

    <form method="post" asp-action="SaveSchedule" class="mb-5">
        <div class="row g-3">
            <div class="col-md-4">
                <label for="date" class="form-label">Select Date</label>
                <input type="date" id="date" name="Date" value="@Model.SelectedDate.ToString("yyyy-MM-dd")" class="form-control" required />
            </div>
            <div class="col-md-3">
                <label for="startTime" class="form-label">Start Time</label>
                <select id="startTime" name="StartTime" class="form-control" required>
                    @for (var hour = 8; hour <= 17; hour++)
                    {
                        <option value="@($"{hour:D2}:00")">@($"{hour:D2}:00")</option>
                        <option value="@($"{hour:D2}:30")">@($"{hour:D2}:30")</option>
                    }
                </select>
            </div>

            <div class="col-md-3">
                <label for="endTime" class="form-label">End Time</label>
                <select id="endTime" name="EndTime" class="form-control" required>
                    @for (var hour = 8; hour <= 18; hour++)
                    {
                        <option value="@($"{hour:D2}:00")">@($"{hour:D2}:00")</option>
                        <option value="@($"{hour:D2}:30")">@($"{hour:D2}:30")</option>
                    }
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <div class="form-check">
                    <input type="checkbox" id="isAvailable" name="IsAvailable" class="form-check-input" checked />
                    <label for="isAvailable" class="form-check-label">Available</label>
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-primary mt-3 w-100">Save Slot</button>
    </form>

    <hr />

    <h2 class="mb-3 text-center">Your Weekly Schedule</h2>

    <div class="table-responsive">
        <table class="schedule-table table table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Date</th>
                    @for (var hour = 8; hour <= 18; hour++)
                    {
                        <th>@hour:00</th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var date in Enumerable.Range(0, 7).Select(d => Model.SelectedDate.AddDays(d)))
                {
                    <tr>
                        <td class="fw-bold">@date.ToString("ddd, MMM dd")</td>

                        @for (var hour = 8; hour <= 18; hour++)
                        {
                            var slot = Model.DoctorSchedules
                            .FirstOrDefault(ds => ds.Date == date &&
                            ds.StartTime.Hours <= hour &&
                            ds.EndTime.Hours > hour &&
                            ds.IsAvailable);

                            if (slot != null)
                            {
                                <td class="available" title="Available: @slot.StartTime:hh\\:mm - @slot.EndTime:hh\\:mm">Available</td>
                            }
                            else
                            {
                                <td class="unavailable"></td>
                            }
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        const form = document.querySelector('form[asp-action="SaveSchedule"]');
        const startTime = document.getElementById('startTime');
        const endTime = document.getElementById('endTime');

        form.addEventListener('submit', function(e) {
            const start = startTime.value;
            const end = endTime.value;

            const [startH, startM] = start.split(':').map(Number);
            const [endH, endM] = end.split(':').map(Number);

            const startMinutes = startH * 60 + startM;
            const endMinutes = endH * 60 + endM;

            if (endMinutes <= startMinutes) {
                e.preventDefault();
                alert('End time must be later than start time!');
            }
        });

        startTime.addEventListener('change', function() {
            const start = startTime.value;
            const [startH, startM] = start.split(':').map(Number);
            const startMinutes = startH * 60 + startM;

            for (let option of endTime.options) {
                const [endH, endM] = option.value.split(':').map(Number);
                const endMinutes = endH * 60 + endM;
                option.disabled = endMinutes <= startMinutes;
            }

            if (endTime.selectedOptions[0].disabled) {
                const firstValid = Array.from(endTime.options).find(opt => !opt.disabled);
                if (firstValid) endTime.value = firstValid.value;
            }
        });
    </script>
}